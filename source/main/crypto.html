<!DOCTYPE html>
<html lang="en">

<head>
    <title>Crypto Window</title>
</head>

<body>
    <div>
        <input type="text" name="data" id="data" autofocus />
    </div>
    <!-- <button id="click" onclick="Tidify()">Tidify</button> -->
</body>
<script type="module">
    import { Heimdall, TidePromise, FieldData } from "https://unpkg.com/heimdall-tide@0.0.50-test/src/heimdall.js";

    //Channel to send and receive must be whitelisted in the preload.js file
    // TO send data
    //window.api.send("toMain", param);

    //TO receive data
    //
    console.log("Crypto Window")
    const config = {
        vendorPublic: "us7ieal6GOfYgcVJa50cdqp78qBLy6zqv7zvuqbR34U=",
        appOriginText: "securing the vendorurl",
        appOriginTextSignature: "2T0gMbfNFDk69vzHQUBa2ExHDBFkUfG7h00SQ1KPLuIv5som+GOt18ujVIgg8qnCXw4duuCFRb/uHWe0h1a2Aw==",
        homeORKUrl: "https://prod-ork3.azurewebsites.net",
        enclaveRequest: {
            getUserInfoFirst: false, // 1 step process - we will not supply a customModel halfway through the process
            refreshToken: true, // I want a TideJWT returned
            customModel: undefined // I do not want to provide a customModel
        }
    }

    let jwt = ""

    window.api.receive("fromMain", async (sentData) => {
        let data = JSON.parse(sentData);
        console.log(typeof (data));
        console.log(data);

        let identity = data.id;

        console.log(identity);

        switch (identity) {
            case "encrypt":
                console.log("checking");
                await encrypt(data);
                break;
            case "decrypt":
                await decrypt(data);
                break;
        }
    });

    async function encrypt(jsonData) {
        console.log("checking data got: ", jsonData);
        let jwt = jsonData.token;
        let data = jsonData.data;

        const heimdall = new Heimdall(config);
        const tidePromise = new TidePromise(); // a TidePromise which allows us to get the values from the FULL sign in process

        const fieldData = new FieldData(["vault1"]);
        fieldData.add(data, ["vault1"]);

        const params = [jwt, fieldData, tidePromise];

        const tideButtonAction = async function (params) {
            heimdall.TESTencryptUserDataTEST(params); // describe what we want the tide button to do
            const encryptedValues = await tidePromise.promise;

            jsonData.data = encryptedValues;
            console.log("Encrypted data " + jsonData.data);
            document.getElementById("data").innerHTML = jsonData.data;
            window.api.send('toMain', JSON.stringify(jsonData));
        }

        const tideButton = heimdall.AddTideButton(tideButtonAction, params); // returns Tide Button for you to stylise
        tideButton.click();
    }

    async function decrypt(jsonData) {
        console.log("In decrypt function in crypto window!");
        let jwt = jsonData.token;
        let data = jsonData.data;

        const heimdall = new Heimdall(config);
        const tidePromise = new TidePromise(); // a TidePromise which allows us to get the values from the FULL sign in process

        const fieldData = new FieldData(["vault1"]);
        fieldData.add(data, ["vault1"]);

        const params = [jwt, fieldData, tidePromise];

        const tideButtonAction = async function (params) {

            heimdall.TESTdecryptUserDataTEST(params); // describe what we want the tide button to do
            const decryptedValues = await tidePromise.promise; // the security of doing this is suspect! ~Muddykat

            console.log(decryptedValues);

            jsonData.data = decryptedValues;
            console.log("Decrypted data: " + jsonData.data);
            document.getElementById("data").innerHTML = jsonData.data;
            window.api.send('toMain', JSON.stringify(jsonData));
        }

        const tideButton = heimdall.AddTideButton(tideButtonAction, params); // returns Tide Button for you to stylise
        tideButton.click();
    }

</script>

</html>